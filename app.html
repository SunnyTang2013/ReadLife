<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Scorch - Job Scheduling and Monitoring System" />
    <meta name="theme-color" content="#000000" />
    <title>Scorch</title>
    <link rel="stylesheet" href="/dist/vendors.css" />
    <link rel="stylesheet" href="/dist/common.css" />
    <link rel="stylesheet" th:href="${'/css/' + theme + '.min.css'}" />
    <link rel="stylesheet" th:href="${'/dist/' + app.name + '.css'}" />
    <link rel="shortcut icon" th:href="${'/img/scorch-logo-' + theme + '.png'}" type="image/x-icon">
    <link rel="manifest" href="/manifest.json" />
  </head>

  <body>
    <!-- Fallback for users with JavaScript disabled -->
    <noscript>You need to enable JavaScript to run this application.</noscript>
    
    <!-- React 18 app root with improved accessibility -->
    <div id="app" role="main" aria-label="Scorch Application"></div>

    <!-- Loading indicator for better UX -->
    <div id="initial-loading" style="
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0; 
      background: #fff; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 9999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    ">
      <div style="text-align: center;">
        <div style="
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
        "></div>
        <p style="color: #666; margin: 0;">Loading Scorch...</p>
      </div>
    </div>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- Define error handlers before any scripts -->
    <script>
      // Script loading success handler
      function handleScriptSuccess(script) {
        console.log('‚úÖ Script loaded successfully:', script.src);
      }
      
      // Script loading error handler
      function handleScriptError(script) {
        console.error('‚ùå Failed to load script:', script.src);
        var loading = document.getElementById('initial-loading');
        if (loading) {
          loading.innerHTML = '<div style="text-align: center; color: #e74c3c;"><h3>Failed to load application</h3><p>Script: ' + script.src + '</p><p>Please refresh the page or contact support.</p></div>';
        }
      }
    </script>

    <!-- Global configuration for React app -->
    <script th:inline="javascript">
      window.routerBasename = [[${app != null ? app.routerBasename : '/'}]];
      window.appConfig = {
        theme: [[${theme != null ? theme : 'default'}]],
        appName: [[${app != null ? app.name : 'scorch'}]],
        currentUser: [[${currentUser}]],
        build: [[${build}]]
      };
      
      // Debug information
      console.log('=== DEBUG INFO ===');
      console.log('App object:', [[${app}]]);
      console.log('App name from server:', [[${app != null ? app.name : 'NULL'}]]);
      console.log('Router basename:', window.routerBasename);
      console.log('App config:', window.appConfig);
      console.log('Expected script path:', '/dist/' + window.appConfig.appName + '.bundle.js');
      
      // Hide loading indicator once React app is ready
      document.addEventListener('DOMContentLoaded', function() {
        // Remove loading indicator after a reasonable delay or when app renders
        setTimeout(function() {
          var loading = document.getElementById('initial-loading');
          if (loading) {
            loading.style.display = 'none';
          }
        }, 2000);
      });
      
      // Additional check to hide loading when React app mounts
      window.hideLoadingIndicator = function() {
        var loading = document.getElementById('initial-loading');
        if (loading) {
          loading.style.display = 'none';
        }
      };
      
      // Alternative method: Monitor app div for changes
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' && mutation.target.id === 'app' && mutation.target.hasChildNodes()) {
            setTimeout(function() {
              window.hideLoadingIndicator();
            }, 500);
            observer.disconnect();
          }
        });
      });
      
      observer.observe(document.getElementById('app'), {
        childList: true,
        subtree: true
      });
    </script>

    <!-- Load scripts in optimized order for React 18 -->
    <!-- Load shared dependencies first -->
    <script src="/dist/prerequisites.bundle.js" onload="handleScriptSuccess(this)" onerror="handleScriptError(this)"></script>
    <script src="/dist/vendors.bundle.js" onload="handleScriptSuccess(this)" onerror="handleScriptError(this)"></script>
    <script src="/dist/react.bundle.js" onload="handleScriptSuccess(this)" onerror="handleScriptError(this)"></script>
    <!-- Charts bundle only loaded for modules that need it (like monitoring and metrics) -->
    <script th:if="${app != null && (app.name == 'monitoring' || app.name == 'metrics')}" src="/dist/charts.bundle.js" onload="handleScriptSuccess(this)" onerror="handleScriptError(this)"></script>
    <!-- Load common shared components -->
    <script src="/dist/common.bundle.js" onload="handleScriptSuccess(this)" onerror="handleScriptError(this)"></script>
    <!-- Finally load the specific app bundle with its own runtime -->
    <script th:src="${'/dist/' + (app != null ? app.name : 'scorch') + '.bundle.js'}" defer onload="handleScriptSuccess(this); console.log('üöÄ Main app script loaded! React should be mounting now...');" onerror="handleScriptError(this)"></script>

    <!-- Enhanced error handling -->
    <script>
      // Log all script elements being added
      document.addEventListener('DOMContentLoaded', function() {
        var scripts = document.querySelectorAll('script[src]');
        console.log('=== ALL SCRIPT TAGS ===');
        scripts.forEach(function(script, index) {
          console.log('Script ' + index + ':', script.src);
        });
      });
      
      // Global error handlers
      window.addEventListener('error', function(e) {
        console.error('Global error:', e.error || e.message);
        // Check if this is a script loading error
        if (e.target && e.target.tagName === 'SCRIPT') {
          handleScriptError(e.target);
        }
      });
      
      window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
      });
      
      // Fallback timeout to show error if app doesn't load
      setTimeout(function() {
        var loading = document.getElementById('initial-loading');
        var appElement = document.getElementById('app');
        if (loading && loading.style.display !== 'none' && 
            (!appElement || !appElement.hasChildNodes())) {
          loading.innerHTML = '<div style="text-align: center; color: #e67e22;"><h3>App taking too long to load</h3><p>Please check your network connection and refresh the page.</p><button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload Page</button></div>';
        }
      }, 10000);
    </script>

  </body>

</html>
